package org.conxworks.paas.monitoring.alertbot.notifier.itest;

import java.util.List;
import java.util.Properties;
import java.util.concurrent.TimeUnit;

import org.amdatu.bndtools.test.BaseOSGiServiceTest;
import org.conxworks.paas.monitoring.alertbot.api.IAlertNotifier;


public class SearchEventsTest extends BaseOSGiServiceTest<IAlertNotifier> {
	private volatile IAlertNotifier notifier;
	
	public SearchEventsTest() {
		super(IAlertNotifier.class);
	}
	
	@Override
	public void setUp() throws Exception {
		Properties searchProperties = new Properties();
		searchProperties.put("repository", "webshop");
		configureFactory("org.amdatu.search.solr", searchProperties);
		
		Properties mongoProperties = new Properties();
		mongoProperties.put("dbName", "webshoptests");
		configureFactory("org.amdatu.mongo", mongoProperties);
		
		addServiceDependencies(MongoDBService.class, ProductService.class);
		super.setUp();
		
		collection = mongoDBService.getDB().getCollection("products");
		
		collection.remove(new BasicDBObject());
	}
	
    public void testNewProductIndexEvent() throws InterruptedException {
    	Product newProduct = new Product();
    	newProduct.setName("Modular Java in the Cloud");
    	productService.saveProduct(newProduct);
    	
    	//Events are posted asynchronously.
    	TimeUnit.SECONDS.sleep(1);
    	
    	List<Product> findProducts = instance.findProducts("modular AND java");
    	assertEquals(1, findProducts.size());
    }
    
    public void testUpdatedProductIndexEvent() throws InterruptedException {
    	Product newProduct = new Product();
    	newProduct.setName("Something with Cloud");
    	productService.saveProduct(newProduct);
    	
    	//Events are posted asynchronously.
    	TimeUnit.SECONDS.sleep(1);
    	
    	assertEquals(0, instance.findProducts("modular AND java").size());
    	assertEquals(1, instance.findProducts("cloud").size());
    	
    	newProduct.setName("modular java");
    	productService.saveProduct(newProduct);
    	
    	TimeUnit.SECONDS.sleep(1);
    	
    	assertEquals(1, instance.findProducts("modular AND java").size());
    	assertEquals(0, instance.findProducts("cloud").size());
    }
    
    public void testRemovedProductIndexEvent() throws InterruptedException {
    	Product newProduct = new Product();
    	newProduct.setName("Modular Java in the Cloud");
    	productService.saveProduct(newProduct);
    	
    	//Events are posted asynchronously.
    	TimeUnit.SECONDS.sleep(1);
    	
    	assertEquals(1, instance.findProducts("modular AND java").size());
    	
    	productService.removeProduct(newProduct.get_id());
    	
    	TimeUnit.SECONDS.sleep(1);
    	
    	assertEquals(0, instance.findProducts("modular AND java").size());
    }
}
